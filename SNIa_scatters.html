<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scatters</title>
    <script type="text/javascript" src="js/d3.v4.js"></script>
    <script type="text/javascript" src="js/draw_L3.js"></script>
    <script type="text/javascript" src="js/data1.js"></script>
    <script type="text/javascript" src="js/data2.js"></script>
    <script type="text/javascript" src="js/data3.js"></script>
    <script type="text/javascript" src="js/data5.js"></script>

    <style type="text/css">
        .axis {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .dot2 {
            fill: steelblue;
        }

        .zoom {
            fill: none;
            pointer-events: all;
        }

        #L3Img.hidden0 {
            display: none;
        }

        #L3Img {
            position: absolute;
            top: 700px;
            left: 25px;
            pointer-events: none;
            opacity: 0.95;
        }

        
        #L2dialog {
            position: absolute;
            width: 60px;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        #L2dialog.hidden {
            display: none;
        }

        #L2dialog p {
            margin: 0;
            font-family: sans-serif;
            font-size: 12px;
            line-height: 20px;
        }
    </style>
</head>
<body>

<div id="L3Img" class="hidden0" width="800" height="600">
    <svg id="mainSVG"></svg>
</div>

<div id="L2dialog" class="hidden">
    <p><strong>SNIa: </strong><span id="L3value"></span></p>
</div>

<script>
    // true is scatter for M0 and x, false is scatter for M0 and c
    var M0_x = true;

    // svg attr
    var marginL2 = { top: 40, right: 20, bottom: 20, left: 40 };
    var widthL2 = 960;
    var heightL2 = 640;

    var chosenSNIa1;
    var chosenSNIa2;

    // create SVG element for drawing scatters
    var svg = d3.select("body")
            .append("svg")
            .attr("class", "svg")
            .attr("width", widthL2)
            .attr("height", heightL2);

    // scale functions
    var x = d3.scaleLinear()
            .domain([d3.min(data1, function(d) { return d.m_mu; }), d3.max(data1, function(d) { return d.m_mu; })])
            .range([0, widthL2 - 1]);
    var y = d3.scaleLinear()
            .domain([d3.min(data1, function(d) { return d.x; }), d3.max(data1, function(d) { return d.x; })])
            .range([heightL2 - 1, 0]);

    // x and y axis
    var xAxis = d3.axisTop(x);
    var yAxis = d3.axisRight(y);

    // create x and y axis
    var gx = svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0, " + (heightL2 - 1)+ ")")
            .call(xAxis);
    var gy = svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0, 0)")
            .call(yAxis);

    // define key function
    var key = function(d) { return d.key; }

    // group all data dots
    var g_dots = svg.append("g");

    // create data dots
    var circles = g_dots.selectAll("circle")
            .data(data1, key)
            .enter()
            .append("circle")
            .attr("class", "dot")
            .attr("cx", function(d) { return x(d.m_mu); })
            .attr("cy", function(d) { return y(d.x); })
            .attr("r", 8)
            .attr("fill", function(d) {
                var color = data2[d.key-1].color;
                var R = Math.floor((0.3 + color) * 255 / 0.6);
                var B = Math.floor((0.3 - color) * 255 / 0.6);
                return "rgb(" + R + ", 0, " + B + ")";
            })
            .on("mouseover", function(d) {
                var xPosition = parseFloat(d3.select(this).attr("cx")) + 20;
                var yPosition = parseFloat(d3.select(this).attr("cy"));
                d3.select("#L2dialog")
                        .style("left", xPosition + "px")
                        .style("top", yPosition + "px")
                        .select("#L3value")
                        .text(d.key);

                d3.select("#L2dialog").classed("hidden", false);
            })
            .on("mouseout", function() {
                d3.select("#L2dialog").classed("hidden", true);
            })
            .on("click", function(d) {
                if (d3.select("#L3Img").attr("class") == "hidden0") {
                    chosenSNIa1 = d.key - 1;
                    createLevel3Image(chosenSNIa1, chosenSNIa2);
                    d3.select("#L3Img").attr("class", "hidden1");
                } else if (d3.select("#L3Img").attr("class") == "hidden1") {
                    chosenSNIa2 = d.key - 1;
                    createLevel3Image(chosenSNIa1, chosenSNIa2);
                    d3.select("#L3Img").attr("class", "hidden2");
                }
            });

    // press key ESC to conceal L3Img
    d3.select("body")
            .on("keydown", function(d) {
                if (event.key == "Escape") {
                    d3.select("#L3Img").attr("class", "hidden0");
                    d3.select("#mainSVG").remove();
                    d3.select("#L3Img").append("svg").attr("id", "mainSVG");
                    chosenSNIa1 = undefined;
                    chosenSNIa2 = undefined;
                }
            });

    // define zoom attr
    var zoom = d3.zoom()
            .scaleExtent([0.75, 20])
            .translateExtent([[-widthL2/2, -heightL2/2], [widthL2*3/2, heightL2*3/2]])
            .on("zoom", function() {
                // zoom g_dots group

                g_dots.attr("transform", d3.event.transform);
                circles.attr("r", 8 / d3.event.transform.k);

                gx.call(xAxis.scale(d3.event.transform.rescaleX(x)));
                gy.call(yAxis.scale(d3.event.transform.rescaleY(y)));

            });

    // create a rect for zooming
    svg.call(zm = zoom);

    // create a button for converting between the two scatters
    d3.select("body")
            .append("button")
            .text("turn")
            .on("click", function() {
                // convert between M0_x and M0_c, and change the dataset
                M0_x = !M0_x;

                if (M0_x) {
                    // redraw y axis
                    y.domain([d3.min(data1, function(d) { return d.x; }), d3.max(data1, function(d) { return d.x; })]);
                    gy.call(yAxis);

                    // redraw dots
                    g_dots.selectAll("circle")
                            .data(data1, key)
                            .attr("cx", function(d) {
                                return x(d.m_mu);
                            })
                            .attr("cy", function(d) {
                                return y(d.x);
                            });
                } else {
                    // redraw y axis
                    y.domain([d3.min(data1, function(d) { return d.c; }), d3.max(data1, function(d) { return d.c; })]);
                    gy.call(yAxis);

                    // redraw dots
                    g_dots.selectAll("circle")
                            .data(data1, key)
                            .attr("cx", function(d) {
                                return x(d.m_mu);
                            })
                            .attr("cy", function(d) {
                                return y(d.c);
                            });
                }

                //d3.selection.call(zoom.transform, d3.zoomIdentity);
                //d3.selection.call(zoom.scaleTo, d3.zoomIdentity);
            });

    /*
    d3.select("body")
            .append("button")
            .text("turn")
            .on("click", function() {
                d3.transition()
                        .duration(250)
                        .tween("zoom", svg.call(zoom.translate([0, 0]).scale(1).event));
            });
    */
</script>
</body>
</html>