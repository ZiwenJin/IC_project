<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scatters</title>
    <script type="text/javascript" src="js/d3.v4.js"></script>
    <script type="text/javascript" src="js/jquery-3.1.0.js"></script>
    <script type="text/javascript" src="js/jquery-ui.js"></script>
    <script type="text/javascript" src="js/draw_L3.js"></script>
    <script type="text/javascript" src="js/dataLevel2.js"></script>
    <script type="text/javascript" src="js/dataLevel2Color.js"></script>
    <script type="text/javascript" src="js/dataLevel3Simple.js"></script>

    <link rel="stylesheet" type="text/css" href="js/jquery-ui.css">

    <style type="text/css">
        .axis {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        #L3Img.hidden0 {
            display: none;
        }

        #L3Img {
            position: absolute;
            top: 700px;
            left: 25px;
            pointer-events: none;
            opacity: 0.95;
        }

        #mainSVG {
            background-color: white;
        }

        #L2dialog1, #L2dialog2, #L2dialog3 {
            position: absolute;
            width: 180px;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        #L2dialog1 p, #L2dialog2 p, #L2dialog3 p {
            margin: 0;
            font-family: sans-serif;
            font-size: 12px;
            line-height: 20px;
        }

        .hidden {
            display: none;
        }
    </style>

    <script>
        $(function() {
            $("#tabs").tabs();
        });
    </script>
</head>
<body>

<div id="tabs">
    <ul>
        <li><a href="#L2MBiVSX1i">(M<sub>Bi</sub> - &mu;<sub>i</sub>) vs. x<sub>1i</sub></a></li>
        <li><a href="#L2MBiVSCi">(M<sub>Bi</sub> - &mu;<sub>i</sub>) vs. c<sub>i</sub></a></li>
        <li><a href="#L2ZVSMu">z vs. &mu;</a></li>
        <li><a href="#L3Vis"><span>SN _ vs. SN _</span></a></li>
    </ul>

    <div id="L2MBiVSX1i" class="L2parent">
    </div>
    <div id="L2MBiVSCi" class="L2parent">
    </div>
    <div id="L2ZVSMu" class="L2parent">
    </div>
    <div id="L3Vis" class="L2parent">
    </div>
</div>


<div id="L3Img" class="hidden0" width="800" height="600">
    <svg id="mainSVG"></svg>
</div>

<div id="L2dialog1" class="hidden">
    <p><strong>SNIa: </strong><span class="L2DialogID"></span></p>
    <p><strong>m<sub>B</sub> - &mu;:&emsp;</strong><span class="L2DialogVarXValue"></span></p>
    <p><strong>x:&emsp;</strong><span class="L2DialogVarYValue"></span></p>
</div>
<div id="L2dialog2" class="hidden">
    <p><strong>SNIa: </strong><span class="L2DialogID"></span></p>
    <p><strong>m<sub>B</sub> - &mu;:&emsp;</strong><span class="L2DialogVarXValue"></span></p>
    <p><strong>c:&emsp;</strong><span class="L2DialogVarYValue"></span></p>
</div>
<div id="L2dialog3" class="hidden">
    <p><strong>SNIa: </strong><span class="L2DialogID"></span></p>
    <p><strong>redshift:&emsp;</strong><span class="L2DialogVarXValue"></span></p>
    <p><strong>&mu;:&emsp;</strong><span class="L2DialogVarYValue"></span></p>
</div>

<script>
    // true is scatter for M0 and x, false is scatter for M0 and c
    var M0_x = true;
    // svg attr
    var marginL2 = { top: 40, right: 20, bottom: 20, left: 40 };
    var widthL2 = 900;
    var heightL2 = 600;

    var chosenSNIa1;
    var chosenSNIa2;

    drawScatterPlot("L2MBiVSX1i", "m_mu", "x", 1);
    drawScatterPlot("L2MBiVSCi", "m_mu", "c", 2);
    drawScatterPlot("L2ZVSMu", "z", "mu", 3);

    //drawScatterPlot("L2MBiVSX1i", 1, 2);
    //drawScatterPlot("L2MBiVSCi", 1, 2);

    function drawScatterPlot(panelID, varX, varY, panelNum) {
        var zoomTransformK = 1;
        var zoomTransformX = 0;
        var zoomTransformY = 0;

        function selectData(dataset, varName) {
            if (varName == "m_mu") { return dataset.m_mu; }
            else if (varName == "x") { return dataset.x; }
            else if (varName == "c") { return dataset.c; }
            else if (varName == "z") { return dataset.z; }
            else if (varName == "mu") { return dataset.mu; }
        }

        function varName(varName) {
            if (varName == "m_mu") { return "m<sub>B</sub>-&mu;&emsp;"; }
            else if (varName == "x") { return "x: "; }
            else if (varName == "c") { return "c: "; }
            else if (varName == "z") { return "z: "; }
            else if (varName == "mu") { return "mu: "; }
        }

        // create SVG element for drawing scatters
        var svg = d3.select("#" + panelID)
                .append("svg")
                .attr("class", "svg")
                .attr("width", widthL2)
                .attr("height", heightL2);

        // scale functions
        var x = d3.scaleLinear()
                .domain([d3.min(data1, function(d) {
                    return selectData(d, varX);
                }), d3.max(data1, function(d) {
                    return selectData(d, varX);
                })])
                .range([0, widthL2 - 1]);
        var y = d3.scaleLinear()
                .domain([d3.min(data1, function(d) {
                    return selectData(d, varY)
                }), d3.max(data1, function(d) {
                    return selectData(d, varY)
                })])
                .range([heightL2 - 1, 0]);

        // x and y axis
        var xAxis = d3.axisTop(x);
        var yAxis = d3.axisRight(y);

        // create x and y axis
        var gx = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0, " + (heightL2 - 1)+ ")")
                .call(xAxis);
        var gy = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0, 0)")
                .call(yAxis);

        // define key function
        var key = function(d) { return d.key; }

        // group all data dots
        var g_dots = svg.append("g");

        // create data dots
        var circles = g_dots.selectAll("circle")
                .data(data1, key)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("id", function(d) { return "dot" + d.key; })
                .attr("cx", function(d) {
                    return x(selectData(d, varX));
                })
                .attr("cy", function(d) {
                    return y(selectData(d, varY));
                })
                .attr("r", 6)
                .attr("fill", function(d) {
                    var color = data2[d.key-1].color;
                    var R = Math.floor((0.3 + color) * 255 / 0.6);
                    var B = Math.floor((0.3 - color) * 255 / 0.6);
                    return "rgb(" + R + ", 0, " + B + ")";
                })
                .on("mouseover", function(d) {
                    //var xPosition = (parseFloat(d3.select(this).attr("cx"))) / d3.event.transform.k;
                    //var yPosition = (parseFloat(d3.select(this).attr("cy"))) / d3.event.transform.k;

                    d3.select("#L2dialog" + panelNum)
                            .style("left", zoomTransformK * x(selectData(d, varX)) + zoomTransformX + 40 + "px")
                            .style("top", zoomTransformK * y(selectData(d, varY)) + zoomTransformY + 90 + "px");
                    d3.select("#L2dialog" + panelNum)
                            .select(".L2DialogID")
                            .text(d.key);
                    d3.select("#L2dialog" + panelNum)
                            .select(".L2DialogVarXValue")
                            .text(x(selectData(d, varX)));
                    d3.select("#L2dialog" + panelNum)
                            .select(".L2DialogVarYValue")
                            .text(y(selectData(d, varY)));
                    d3.select("#L2dialog" + panelNum)
                            .classed("hidden", false);
                })
                .on("mouseout", function() {
                    d3.select("#L2dialog" + panelNum)
                            .classed("hidden", true);
                })
                .on("click", function(d) {
                    if (d3.select("#L3Img").attr("class") == "hidden0") {
                        chosenSNIa1 = d.key - 1;
                        createLevel3Image(chosenSNIa1, chosenSNIa2);
                        d3.select("#L3Img").attr("class", "hidden1");
                        // create a new circle to overlap the chosen one, which is also easy to remove
                        g_dots.append("circle")
                                .attr("class", "dot")
                                .attr("id", "chosenDot1")
                                .attr("cx", x(data1[d.key-1].m_mu))
                                .attr("cy", y(data1[d.key-1].x))
                                .attr("r", 8)
                                .attr("fill", "orange");
                        //document.getElementById("dot" + d.key).style.pointerEvents = "none";
                    } else if (d3.select("#L3Img").attr("class") == "hidden1") {
                        chosenSNIa2 = d.key - 1;
                        createLevel3Image(chosenSNIa1, chosenSNIa2);
                        d3.select("#L3Img").attr("class", "hidden2");
                        g_dots.append("circle")
                                .attr("class", "dot")
                                .attr("id", "chosenDot2")
                                .attr("cx", x(data1[d.key-1].m_mu))
                                .attr("cy", y(data1[d.key-1].x))
                                .attr("r", 8)
                                .attr("fill", "green");
                    }
                });


        // press key ESC to conceal L3Img
        d3.select("body")
                .on("keydown", function(d) {
                    if (event.key == "Escape") {
                        d3.select("#L3Img").attr("class", "hidden0");
                        d3.select("#mainSVG").remove();
                        d3.select("#L3Img").append("svg").attr("id", "mainSVG");
                        d3.select("#chosenDot1").remove();
                        d3.select("#chosenDot2").remove();
                        //document.getElementById("dot" + (chosenSNIa1+1)).style.pointerEvents = "auto";
                        chosenSNIa1 = undefined;
                        chosenSNIa2 = undefined;
                    }
                });

        // define zoom attr
        var zoom = d3.zoom()
                .scaleExtent([0.75, 20])
                .translateExtent([[-widthL2/2, -heightL2/2], [widthL2*3/2, heightL2*3/2]])
                .on("zoom", function() {
                    // zoom g_dots group
                    g_dots.attr("transform", d3.event.transform);
                    circles.attr("r", 6 / d3.event.transform.k);
                    d3.select("#chosenDot1").attr("r", 8 / d3.event.transform.k);
                    d3.select("#chosenDot2").attr("r", 8 / d3.event.transform.k);

                    zoomTransformK = d3.event.transform.k;
                    zoomTransformX = d3.event.transform.x;
                    zoomTransformY = d3.event.transform.y;

                    gx.call(xAxis.scale(d3.event.transform.rescaleX(x)));
                    gy.call(yAxis.scale(d3.event.transform.rescaleY(y)));

                });

        // create a rect for zooming
        svg.call(zm = zoom);
    }

</script>
</body>
</html>